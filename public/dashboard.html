<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PurpleBot Dashboard</title>
  <link rel="stylesheet" href="/dashboard.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div id="dashboard">
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>ðŸ“Š PurpleBot</h2>
      <div class="portfolio">
        <h3>ðŸ‘¤ Account</h3>
        <p id="acct-name">Loading...</p>
        <h3>ðŸ’° Balance</h3>
        <div class="balance-value" id="acct-balance">$0.00</div>
      </div>

      <label for="model-upload" class="label-upload">ðŸ“¦ Upload Model</label>
      <input type="file" id="model-upload" class="upload-input" accept=".zip" />

      <label for="symbol-selector" class="label-upload">ðŸ”„ Select Symbol</label>
      <select id="symbol-selector" class="upload-btn">
        <option value="R_50">R_50</option>
        <option value="R_100">R_100</option>
        <option value="Volatility_25">Volatility 25</option>
        <option value="Volatility_75">Volatility 75</option>
      </select>

      <button onclick="openChat()">ðŸ’¬ Chat with Libra</button>
    </div>

    <!-- Main Panel -->
    <div class="main-panel">
      <div class="header">
        <h2>ðŸ“ˆ Live Market Chart - <span id="symbol-name">R_50</span></h2>
        <small id="last-updated">Updated: --</small>
      </div>

      <div class="chart-container">
        <canvas id="priceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Chat Panel -->
  <div id="chat-panel">
    <header>Libra ðŸ’¬</header>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input type="text" id="chat-text" placeholder="Ask Libra..." />
      <button onclick="sendChat()">âž¤</button>
    </div>
  </div>

  <!-- Floating Trade Button -->
  <div id="trade-buttons" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:999;">
    <button onclick="placeTrade('buy')">ðŸŸ¢ Buy</button>
    <button onclick="placeTrade('sell')">ðŸ”´ Sell</button>
    <button onclick="placeTrade('close')">âšª Close</button>
  </div>

  <script>
    const acctNameEl = document.getElementById("acct-name");
    const acctBalanceEl = document.getElementById("acct-balance");
    const ctx = document.getElementById('priceChart').getContext('2d');
    const chatPanel = document.getElementById('chat-panel');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-text');
    const symbolSelector = document.getElementById("symbol-selector");
    const symbolName = document.getElementById("symbol-name");

    let currentSymbol = "R_50";

    let chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Price',
          data: [],
          borderColor: '#3d3dff',
          tension: 0.4,
          fill: false
        }]
      },
      options: {
        scales: {
          x: { ticks: { color: '#ccc' }, grid: { color: '#222' } },
          y: { ticks: { color: '#ccc' }, grid: { color: '#222' } }
        },
        plugins: {
          legend: { labels: { color: '#fff' } }
        }
      }
    });

    // Load Chart Data
    async function loadChartData() {
      try {
        const res = await fetch(`/api/chart-data?symbol=${currentSymbol}`);
        const data = await res.json();
        if (data && data.length > 0) {
          const labels = data.map((_, i) => `T${i + 1}`);
          const prices = data.map(p => p.price);
          chart.data.labels = labels;
          chart.data.datasets[0].data = prices;
          chart.update();
          document.getElementById('last-updated').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
        }
      } catch (err) {
        console.error("Chart Error:", err);
      }
    }

    // WebSocket for Account Info
    const ws = new WebSocket("wss://yourserver.com/ws/account");

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.name) acctNameEl.innerText = data.name;
        if (data.balance !== undefined) acctBalanceEl.innerText = `$${parseFloat(data.balance).toFixed(2)}`;
      } catch (e) {
        console.warn("WebSocket Error", e);
      }
    };

    // Upload ZIP model
    document.getElementById('model-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || file.type !== 'application/zip') return alert("Select a .zip file");

      const formData = new FormData();
      formData.append("model", file);

      try {
        const res = await fetch('/api/upload-model', {
          method: 'POST',
          body: formData
        });
        const msg = await res.text();
        alert(`Model uploaded: ${msg}`);
      } catch (err) {
        alert("Upload failed.");
      }
    });

    // Libra Chat
    function openChat() {
      chatPanel.style.display = 'flex';
    }

    async function sendChat() {
      const text = chatInput.value.trim();
      if (!text) return;
      chatMessages.innerHTML += `<div><b>You:</b> ${text}</div>`;
      chatInput.value = '';

      const res = await fetch('/api/ask-libra', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: text })
      });
      const { response } = await res.json();
      chatMessages.innerHTML += `<div><b>Libra:</b> ${response}</div>`;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Trade action
    async function placeTrade(type) {
      try {
        const res = await fetch('/api/trade', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: type, symbol: currentSymbol })
        });
        const result = await res.json();
        alert(`Trade Result: ${result.status || 'Unknown'}`);
      } catch (err) {
        alert("Trade error.");
      }
    }

    // Handle symbol change
    symbolSelector.addEventListener('change', (e) => {
      currentSymbol = e.target.value;
      symbolName.textContent = currentSymbol;
      loadChartData();
    });

    // Initial chart load + interval
    loadChartData();
    setInterval(loadChartData, 3000);
  </script>
</body>
</html>
