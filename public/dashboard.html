<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PurpleBot Dashboard</title>
  <link rel="stylesheet" href="/dashboard.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
</head>
<body>
  <div id="dashboard">
    <!-- Sidebar -->
    <div class="sidebar">
      <h2>📊 PurpleBot</h2>
      <div class="portfolio">
        <h3>👤 Account</h3>
        <p id="acct-name">Loading...</p>
        <h3>💰 Balance</h3>
        <div class="balance-value" id="acct-balance">$0.00</div>
      </div>

      <label for="model-upload" class="label-upload">📦 Upload Model ZIP</label>
      <input type="file" id="model-upload" class="upload-input" accept=".zip" />

      <label for="symbol-selector" class="label-upload">🔄 Select Symbol</label>
      <select id="symbol-selector" class="upload-btn">
        <option value="R_50">stpRNG</option>
        <option value="R_100">R_100</option>
        <option value="Volatility_25">Step Index</option>
        <option value="Volatility_75">Volatility 75</option>
      </select>

      <button onclick="openChat()">💬 Chat with Libra</button>
    </div>

    <!-- Main Panel -->
    <div class="main-panel">
      <div class="header">
        <h2>📈 Candlestick Chart - <span id="symbol-name">R_50</span></h2>
        <small id="last-updated">Updated: --</small>
      </div>
      <div class="chart-container">
        <canvas id="priceChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Chat Panel -->
  <div id="chat-panel">
    <header>Libra 💬</header>
    <div id="chat-messages"></div>
    <div id="chat-input">
      <input type="text" id="chat-text" placeholder="Ask Libra..." />
      <button onclick="sendChat()">➤</button>
    </div>
  </div>

  <!-- Floating Trade Buttons -->
  <div id="trade-buttons" style="position:fixed; bottom:20px; left:50%; transform:translateX(-50%); z-index:999;">
    <button onclick="placeTrade('buy')">🟢 Buy</button>
    <button onclick="placeTrade('sell')">🔴 Sell</button>
    <button onclick="placeTrade('close')">⚪ Close</button>
  </div>

  <script>
    const acctNameEl = document.getElementById("acct-name");
    const acctBalanceEl = document.getElementById("acct-balance");
    const chatPanel = document.getElementById('chat-panel');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-text');
    const symbolSelector = document.getElementById("symbol-selector");
    const symbolName = document.getElementById("symbol-name");

    let currentSymbol = "R_50";
    let rawTicks = [];
    let candlesticks = [];

    const ctx = document.getElementById('priceChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [{
          label: '5-Tick Candlestick',
          data: [],
          color: {
            up: '#0f0',
            down: '#f00',
            unchanged: '#999'
          }
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: '#fff' } }
        },
        scales: {
          x: {
            ticks: { color: '#ccc' },
            grid: { color: '#222' }
          },
          y: {
            ticks: { color: '#ccc' },
            grid: { color: '#222' }
          }
        }
      }
    });

    async function loadInitialChart() {
      try {
        const res = await fetch(`/api/chart-data`);
        const data = await res.json();
        rawTicks = data.map(t => t.price);
        candlesticks = buildCandles(rawTicks);
        chart.data.datasets[0].data = candlesticks;
        chart.update();
        document.getElementById('last-updated').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
      } catch (err) {
        console.error("Initial Chart Load Error:", err);
      }
    }

    function buildCandles(ticks) {
      const candles = [];
      for (let i = 0; i < ticks.length; i += 5) {
        const slice = ticks.slice(i, i + 5);
        if (slice.length < 5) break;
        const [open, , , , close] = slice;
        const high = Math.max(...slice);
        const low = Math.min(...slice);
        candles.push({
          x: new Date(Date.now() + i * 1000),
          o: open,
          h: high,
          l: low,
          c: close
        });
      }
      return candles;
    }

    function updateCandlesWithTick(price) {
      rawTicks.push(price);
      if (rawTicks.length >= 5 && rawTicks.length % 5 === 0) {
        const newCandle = buildCandles(rawTicks.slice(-5))[0];
        candlesticks.push(newCandle);
        chart.data.datasets[0].data = candlesticks;
        chart.update();
        document.getElementById('last-updated').innerText = `Updated: ${new Date().toLocaleTimeString()}`;
      }
    }

    // WebSocket for Account Info + Ticks
    const ws = new WebSocket("ws://localhost:3001");
    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.fullName) acctNameEl.innerText = data.fullName;
        if (data.accountBalance !== undefined) {
          acctBalanceEl.innerText = `$${parseFloat(data.accountBalance).toFixed(2)}`;
        }
        if (data.currentPrice) {
          updateCandlesWithTick(data.currentPrice);
        }
      } catch (e) {
        console.warn("WS Error:", e);
      }
    };

    // Upload ZIP
    document.getElementById('model-upload').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || file.type !== 'application/zip') return alert("Select a .zip file");

      const formData = new FormData();
      formData.append("model", file);

      try {
        const res = await fetch('/action/upload-zip', {
          method: 'POST',
          body: formData
        });
        const msg = await res.json();
        alert(`✅ ${msg.message}`);
      } catch {
        alert("❌ Upload failed.");
      }
    });

    // Chat
    function openChat() {
      chatPanel.style.display = 'flex';
    }

    async function sendChat() {
      const text = chatInput.value.trim();
      if (!text) return;
      chatMessages.innerHTML += `<div><b>You:</b> ${text}</div>`;
      chatInput.value = '';
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text })
      });
      const { response } = await res.json();
      chatMessages.innerHTML += `<div><b>Libra:</b> ${response}</div>`;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Trade Buttons
    async function placeTrade(type) {
      let url = '';
      if (type === 'buy') url = '/api/trade-buy';
      else if (type === 'sell') url = '/api/trade-sell';
      else url = '/api/close-trades';

      try {
        const res = await fetch(url, { method: 'POST' });
        const result = await res.json();
        alert(`✅ Trade: ${result.type || result.message}`);
      } catch {
        alert("❌ Trade error.");
      }
    }

    // Symbol Change
    symbolSelector.addEventListener('change', (e) => {
      currentSymbol = e.target.value;
      symbolName.textContent = currentSymbol;
      rawTicks = [];
      candlesticks = [];
      loadInitialChart();
    });

    loadInitialChart();
  </script>
</body>
</html>
